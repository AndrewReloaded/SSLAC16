<!DOCTYPE html>
<html>

<head>
    <title>SlSLAC setup HW</title>
</head>

<body bgcolor=#00BEBE>
    <table style=width:800px border=1>
        <caption> NetWork, Time and HardWare Setup </caption>
        <tbody>
            <tr>
                <td style=width:50%>
                    <table style=width:100% border=0>
                        <caption>
                            <button onclick=fPC()>Sync local PC</button> Time setup
                            <button onclick=ntp()>Sync NTP server</button>
                        </caption>
                        <tbody>
                            <tr>
                                <td>TimeZone UTC </td>
                                <td>
                                    <input step=0.5 max=12 min=-12 id=tz onchange="set_save_time('1')" type=number>
                                </td>
                            </tr>
                            <tr>
                                <td>Current Time </td>
                                <td>
                                    <div id=curTime>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
                <td style=width:50%>
                    <table style=width:100% border=0>
                        <caption>I2C setup</caption>
                        <tbody>
                            <tr>
                                <td>SDA GPIO</td>
                                <td>
                                    <input step=1 max=16 min=1 id=pSDA oninput="set_val('pSDA')" type=number>
                                </td>
                            </tr>
                            <tr>
                                <td>SCL GPIO </td>
                                <td>
                                    <input step=1 max=16 min=1 id=pSCL oninput="set_val('pSCL')" type=number>
                                </td>
                            </tr>
                            <tr>
                                <td>PWM freq(Hz) </td>
                                <td>
                                    <input step=10 max=1500 min=40 id=pwmFreq oninput="set_val('pwmFreq')" type=number>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
    <table style=width:800px border=1>
        <tbody>
            <tr>
                <td style=width:50%>
                    <table style=width:100% border=0>
                        <caption>WiFi setup:
                            <input value="Scan WiFi" onclick=scan() type=button>
                        </caption>
                        <tbody>
                            <tr>
                                <td>Hostname</td>
                                <td>
                                    <div id=hostname></div>
                                </td>
                            </tr>
                            <tr>
                                <td>AP IP address: </td>
                                <td>
                                    <div id=ipaddr></div>
                                </td>
                            </tr>
                            <tr>
                                <td>Connected to: </td>
                                <td>
                                    <div id=ssid>
                                        <td>
                                            <button id=discon onclick=disconnect()>Disconnect </td>
                            </tr>
                            <tr>
                                <td>WiFi IP address: </td>
                                <td>
                                    <div id=wifiipaddr></div>
                                </td>
                            </tr>
                            <tr>
                                <td>Network list </td>
                                <td>
                                    <select id=wifi></select>
                                    <td>
                                        <button onclick=connect()>Connect </tr>
                            <tr>
                                <td style=width:100%>Hide own WiFi password
                                    <td>
                                        <input id=isHidePassword onchange=_isHidePassword() type=checkbox>
                                    </td>
                            <tr>
                                <td style=width:100%>Disable AP
                                    <td>
                                        <input id=isSoftAPDisabled onchange=_isSoftAPDisabled() type=checkbox>
                                    </td>
                            <tr>
                                <td style=width:100% colspan=3>You can enable AP and/or show  password by booting SSLAC with "Flash"/"Emergency light" button pressed
                        </tbody>
                    </table>
                    <td>
                        <table border="0" style="width: 100%">
                            <caption>DS18x20 setup:
                                <input value="Scan Sensors" onclick=scan_sens() type=button>
                                <input value="Clear all Sensors" onclick=clear_sens() type=button>
                            </caption>
                            <tbody>
                                <tr>
                                    <td># </td>
                                    <td>Sensor name: </td>
                                    <td>Sensor temperature: </tr>
                                <tr>
                                    <td>
                                        <div id=index0>
                                            <td>
                                                <div id=sname0>
                                                    <td>
                                                        <div id=stemp0>
                                </tr>
                                <tr>
                                    <td>
                                        <div id=index1>
                                            <td>
                                                <div id=sname1>
                                                    <td>
                                                        <div id=stemp1>
                                </tr>
                                <tr>
                                    <td>
                                        <div id=index2>
                                            <td>
                                                <div id=sname2>
                                                    <td>
                                                        <div id=stemp2>
                                </tr>
                                <tr>
                                    <td>
                                        <div id=index3>
                                            <td>
                                                <div id=sname3>
                                                    <td>
                                                        <div id=stemp3>
                                </tr>
                                <tr>
                                    <td>
                                        <div id=index4>
                                            <td>
                                                <div id=sname4>
                                                    <td>
                                                        <div id=stemp4>
                                </tr>
                                <tr>
                                    <td>
                                        <div id=index5>
                                            <td>
                                                <div id=sname5>
                                                    <td>
                                                        <div id=stemp5>
                                </tr>
                                <tr>
                                    <td>
                                        <div id=index6>
                                            <td>
                                                <div id=sname6>
                                                    <td>
                                                        <div id=stemp6>
                                </tr>
                                <tr>
                                    <td>
                                        <div id=index7>
                                            <td>
                                                <div id=sname7>
                                                    <td>
                                                        <div id=stemp7>
                                </tr>
                            </tbody>
                        </table>
        </tbody>
    </table>
    <table style=width:800px border=1>
        <caption>Settings backup</caption>
        <tbody>
            <tr>
                <td>
                    <textarea id="inputTextToSave" style="display:none"></textarea>
                    <table style=width:100% border=0>
                        <tbody>
                            <tr>
                                <td>
                                    Save LED value
                                    <input id="inputFileNameToSaveAs" style="display:none;"></input>
                                </td>
                                <td>
                                    <button onclick="saveTextAsFile()">to File</button>
                                </td>
                            </tr>
                            <tr>
                                <td>Load LED value</td>
                                <td>
                                    <input type="file" id="fileToLoad" accept=".sslac16" onchange="upload.click()">
                                    <button id="upload" onclick="loadFileAsText()" style="display:none;"></button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </td>
            </tr>
        </tbody>
    </table>
    <table style=width:800px border=1>
        <caption>Files update</caption>
        <tbody>
            <tr>
                <td>
                    <table>
                        <caption> Online Update
                            <tbody>
                                <tr border=1>
                                    <td>
                                        <input disabled value="HTML/JS update" onclick="uHTML('pHTML')" style=width:120px;height:20px type=button>
                                        <progress id=pHTML value=0 max=100></progress>
                                        <br>
                                        <input disabled value="FirmWare update" onclick="uFirmWare('pFirmWare')" style=width:120px;height:20px type=button>
                                        <progress id=pFirmWare value=0 max=100></progress>
                                        <br>
                                    </td>
                                </tr>
                            </tbody>
                    </table>
                    <td>
                        <table>
                            <caption>Offline</caption>
                            <tbody>
                                <tr>
                                    <td>
                                        <form id=fileUpload method=POST action=/upload enctype=multipart/form-data>
                                            <input name=myfile1 size=20 lang=en type=file>
                                            <input value=Upload type=submit>
                                        </form>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
            </tr>
        </tbody>
    </table>
    <form>
        <input value=Save onclick=sv() type=button>
        <input type=button onClick=home() value='Daily Schedule'>
        <input type=button onClick="location.href='1SetUp.html'" value='Channels&Group setup'>
        <input type=button onClick="location.href='EmLight.html'" value='Emergency light setup'>
        <input type=button onClick="location.href='Fan.html'" value='Fan/Temperature setup'>
        <input type=button onClick="location.href='setuphw.html'" value=Setup&Upgrade disabled>
        <input value=Reboot \ onclick=sr() type=button>
    </form>
</body>

</html>
<script src=sslac.js></script>
<script>
    set_rest("EmLight=0", _ip);
    var info1, info;
    var foundedNet = [];
    var Sensors = [];
    info = get_rest("info=", _ip);
    document.getElementById("hostname").innerHTML = "<input id='_host'type='text' value=" + info[1][15] + " onchange=set_hn(this) > ";
    setInterval(getInfo1, 1000);

    function getInfo1() {
        info1 = get_rest("info=1", _ip);
        document.getElementById("pSDA").value = info1[1][0];
        document.getElementById("pSCL").value = info1[1][1];
        document.getElementById("pwmFreq").value = info1[1][2];
        if (info1[2][5] == 0) {
            document.getElementById("ipaddr").innerHTML = info1[2][3];
            document.getElementById("wifiipaddr").innerHTML = info1[2][1];
            document.getElementById("ssid").innerHTML = "Not connected";
            document.getElementById("discon").disabled = true
        } else {
            document.getElementById("ipaddr").innerHTML = info1[2][3];
            document.getElementById("wifiipaddr").innerHTML = info1[2][1];
            document.getElementById("ssid").innerHTML = info1[2][2];
            document.getElementById("discon").disabled = false
        }
        var a = "";
        if (info1[0][0] < 10) {
            a = "0" + info1[0][0] + ":"
        } else {
            a = info1[0][0] + ":"
        }
        if (info1[0][1] < 10) {
            a += "0" + info1[0][1] + ":"
        } else {
            a += info1[0][1] + ":"
        }
        if (info1[0][2] < 10) {
            a += "0" + info1[0][2]
        } else {
            a += info1[0][2]
        }
        document.getElementById("curTime").innerHTML = a;
        document.getElementById("tz").value = (info1[0][3] - 127) / 10;
        var b = document.getElementById("fileUpload");
        if (b.action == "file:///upload") {
            b.action = "http://" + _ip + "/upload"
        }
        if (info[6][4] == 1) {
            document.getElementById("isHidePassword").checked = true
        }
        if (info[6][5] == 1) {
            document.getElementById("isSoftAPDisabled").checked = true
        }
    }
    getInfo1();
    getNet();
    setSensor();

    function setSensor() {
        for (i = 0; i < info1[3][0]; i++) {
            Sensors[i] = get_rest("temp=" + i, _ip);
            document.getElementById("index" + i).innerHTML = Sensors[i][8];
            document.getElementById("stemp" + i).innerHTML = Sensors[i][9] / 1000;
            document.getElementById("sname" + i).innerHTML = "<input id='_name" + i + "' onchange=\"sensorName(this)\" type='text' value=" + Sensors[i][10] + "> "
        }
    }

    function sensorName(a) {
        set_rest("temp=" + a.id.substring(5) + "&=" + a.value, _ip)
    }

    function fillNet() {
        var a = document.getElementById("wifi");
        while (a.length != 0) {
            a.remove(a.lengt)
        }
        for (i = 0; i < foundedNet.length; i++) {
            var b = document.createElement("option");
            b.text = foundedNet[i];
            b.value = [i];
            a.add(b)
        }
    }

    function connect() {
        var b = foundedNet[document.getElementById("wifi").value];
        var a = prompt("Please enter password for " + b + " network");
        post_rest("ssid=" + b + "&passwd=" + a, _ip);
        getInfo1();
        getNet()
    }

    function scan() {
        alert("Please wait when scan finished");
        scan_wifi()
    }

    function scan_wifi() {
        info1[2][4] = get_rest("wifi=", _ip);
        getNet()
    }

    function getNet() {
        for (i = 0; i < info1[2][4]; i++) {
            foundedNet[i] = get_rest("wifi=" + i, _ip)[0]
        }
        foundedNet = array_unique(foundedNet);
        fillNet()
    }

    function disconnect() {
        get_rest("wifi=disconnect", _ip);
        getInfo1();
        getNet()
    }

    function fPC() {
        var a = new Date();
        set_rest("time=&h=" + a.getHours() + "&m=" + a.getMinutes() + "&s=" + (a.getSeconds() + 1), _ip)
    }

    function ntp() {
        set_rest("time=ntp", _ip)
    }

    function set_save_time(a) {
        val = parseFloat(document.getElementById("tz").value);
        tz = val;
        val = val * 10 + 127;
        set_rest("&time=&tz=" + val, _ip)
    }

    function _isHidePassword() {
        if (document.getElementById("isHidePassword").checked) {
            alert("Dont forget you default password !!!");
            set_rest("isHidePassword=1", _ip);
            info[6][4] = 1
        } else {
            set_rest("isHidePassword=0", _ip);
            info[6][4] = 0
        }
    }
  
    function _isSoftAPDisabled() {
        if (document.getElementById("isSoftAPDisabled").checked) {
            alert("Dont forget to connect SSLAC to your WiFi network !!!");
            set_rest("isSoftAPDisabled=1", _ip);
            info[6][5] = 1
        } else {
            set_rest("isSoftAPDisabled=0", _ip);
            info[6][5] = 0
        }
    }

    function scan_sens() {
        set_rest("1wire=rescan", _ip)
    }

    function clear_sens() {
        set_rest("1wire=clear", _ip)
    }

    function set_val(a) {
        var b = document.getElementById(a).value;
        set_rest(a + "=" + b, _ip)
    }

    function array_unique(b) {
        var a = [];
        for (var c = 0; c < b.length; c++) {
            if (a.indexOf(b[c]) == -1) {
                a.push(b[c])
            }
        }
        return a
    }

    function set_hn(a) {
        set_rest("hostname=" + a.value)
    }
  
    function loadData() {
        var _data = "";
        var b = [];
        var e;
        document.getElementById("inputTextToSave").value = "[";
        for (i = 0; i < 16; i++) {
            _data = get_rest("chN=" + i, _ip);
            b[i] = _data[0];
            if (_data[4] == 0) {
                document.getElementById("inputTextToSave").value += ("[" + i + "],[" + _data[0] + "],[" + _data[1] + "],[" + _data[2] + "],[" + _data[3] + "],[" + _data[4] + "],[" + _data[5] + '],["' + _data[6] + '"],\r')
            }
        }
        document.getElementById("inputTextToSave").value += "[]]";
        var c = new Date();
        var a = c.getFullYear() + "-" + c.getMonth() + "-" + c.getDate() + "-" + c.getHours() + "-" + c.getMinutes() + "-" + c.getSeconds() + ".sslac16";
        document.getElementById("inputFileNameToSaveAs").value = a
    }

    function saveTextAsFile() {
        loadData();
        var d = document.getElementById("inputTextToSave").value;
        var b = new Blob([d], {
            type: "text/plain"
        });
        var c = document.getElementById("inputFileNameToSaveAs").value;
        var a = document.createElement("a");
        a.download = c;
        a.innerHTML = "Download File";
        if (window.webkitURL != null) {
            a.href = window.webkitURL.createObjectURL(b)
        } else {
            a.href = window.URL.createObjectURL(b);
            a.onclick = destroyClickedElement;
            a.style.display = "none";
            document.body.appendChild(a)
        }
        a.click()
    }

    function destroyClickedElement(a) {
        document.body.removeChild(a.target)
    }

    function loadFileAsText() {
        var c = document.getElementById("fileToLoad").files[0];
        var a = new FileReader();
        a.onload = function(e) {
            var h = e.target.result;
            document.getElementById("inputTextToSave").value = h;
            var d = JSON.parse(h);
            var f = (d.length - 1) / 8;
            var g = 0;
            for (i = 0; i < f; i++) {
                _chN = d[g];
                g++;
                _value = d[g];
                g++;
                _tp = d[g];
                g++;
                _color = d[g];
                g++;
                g++;
                g++;
                g++;
                name_s = "chN=" + _chN + "&=" + d[g];
                g++;
                ch_s = "chN=" + _chN + "&0=" + _value[0] + "&1=" + _value[1] + "&2=" + _value[2] + "&3=" + _value[3] + "&4=" + _value[4] + "&5=" + _value[5] + "&6=" + _value[6] + "&7=" + _value[7] + "&8=" + _value[8] + "&9=" + _value[9] + "&10=" + _value[10] + "&11=" + _value[11] + "&12=" + _value[12] + "&13=" + _value[13] + "&14=" + _value[14] + "&15=" + _value[15];
                tp_s = "tpN=" + _chN + "&0=" + _tp[0] + "&1=" + _tp[1] + "&2=" + _tp[2] + "&3=" + _tp[3] + "&4=" + _tp[4] + "&5=" + _tp[5] + "&6=" + _tp[6] + "&7=" + _tp[7] + "&8=" + _tp[8] + "&9=" + _tp[9] + "&10=" + _tp[10] + "&11=" + _tp[11] + "&12=" + _tp[12] + "&13=" + _tp[13] + "&14=" + _tp[14] + "&15=" + _tp[15];
                
                set_rest(ch_s, _ip);
                set_rest(tp_s, _ip);
                post_rest(name_s, _ip)
            }
        };
        a.readAsText(c, "UTF-8");
        alert("Well Done!")
    };
</script>